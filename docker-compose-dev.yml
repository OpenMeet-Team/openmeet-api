# Local Development Docker Compose
#
# Basic usage (core services only):
#   docker compose -f docker-compose-dev.yml up
#
# Run migrations (first time or after pulling new migrations):
#   docker compose -f docker-compose-dev.yml run --rm migrate
#
# With PDS for ATProto testing (adds isolated PDS + PLC):
#   docker compose -f docker-compose-dev.yml --profile pds up
#
# Start PDS after core is already running:
#   docker compose -f docker-compose-dev.yml --profile pds up -d plc pds

services:
  postgres:
    # use the db with postGIS extensions
    image: postgis/postgis:16-3.4-alpine
    container_name: openmeet_postgres
    ports:
      - ${DATABASE_PORT}:5432
    env_file:
      - .env
    volumes:
      - dbdata:/var/lib/postgresql/data
      # init scripts for PostGIS  
      - ./pg-init-scripts:/docker-entrypoint-initdb.d
    environment:
      POSTGRES_USER: ${DATABASE_USERNAME}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_NAME}
    entrypoint: ["docker-entrypoint.sh", "-c", "max_connections=${DATABASE_MAX_CONNECTIONS}"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USERNAME} -d ${DATABASE_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - api-network

  maildev:
    build:
      context: .
      dockerfile: maildev.Dockerfile
    ports:
      - ${MAIL_CLIENT_PORT}:1080
      - ${MAIL_PORT}:1025
    networks:
      - api-network

  pgadmin:
    image: dpage/pgadmin4
    depends_on:
      - postgres
    ports:
      - "8080:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    restart: always
    networks:
      - api-network

  # Uncomment to use redis
  redis:
    image: redis:7-alpine
    container_name: openmeet_redis
    ports:
      - "6379:6379"
    restart: always
    networks:
      - api-network

  # Database migrations and seeds - run manually when needed
  # Usage: docker compose -f docker-compose-dev.yml run --rm migrate
  # Run after: initial setup, pulling code with new migrations, or schema changes
  migrate:
    profiles: ["migrate"]
    image: node:24-alpine
    user: "${UID:-1000}:${GID:-1000}"
    container_name: openmeet_migrate
    working_dir: /app
    command: sh -c "npm install && npm run migration:run:tenants && npm run seed:run:relational"
    volumes:
      - .:/app
    environment:
      - NODE_ENV=development
      - DATABASE_HOST=postgres
    env_file:
      - .env
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - api-network
    restart: "no"

  # Config renderer - generates Matrix configs from templates for local development
  config-renderer:
    image: alpine:3.19
    container_name: openmeet_config_renderer
    volumes:
      - ./matrix-config:/templates:ro
      - matrix-configs:/rendered-config
    env_file:
      - .env
    restart: "no"
    command: ["/bin/sh", "/templates/render-matrix-config.sh"]
    healthcheck:
      test: ["CMD", "test", "-f", "/rendered-config/mas-config.yaml"]
      interval: 5s
      timeout: 10s
      retries: 3
    networks:
      - api-network

  # Matrix Authentication Service
  matrix-auth-service:
    image: ghcr.io/element-hq/matrix-authentication-service:0.18.0
    container_name: openmeet_mas
    ports:
      - "8081:8080"
    environment:
      MAS_CONFIG: /data/mas-config.yaml
    volumes:
      - matrix-configs:/data:ro
    depends_on:
      config-renderer:
        condition: service_healthy
      postgres:
        condition: service_healthy
    env_file:
      - .env
    networks:
      - api-network
  matrix:
    image: matrixdotorg/synapse:v1.132.0
    container_name: openmeet_matrix
    ports:
      - "8448:8448"
      - "9091:9090"  # Expose Prometheus metrics port (9091 to avoid conflict with system Prometheus)
    environment:
      # Only set the host value that can't come from .env
      POSTGRES_HOST: postgres
      # Set the default Matrix port and host for local development
      MATRIX_HOST: localhost
      MATRIX_PORT: 8448
      # Standard Synapse settings
      SYNAPSE_LOG_LEVEL: "INFO"
      # MAS integration
      MAS_ISSUER: "http://matrix-auth-service:8080/"
      MAS_CLIENT_SECRET: "${MAS_CLIENT_SECRET}"
    volumes:
      - matrix-configs:/config:ro
      - ./matrix-config/log.config:/data/log.config
      - ./matrix-config/init.sh:/data/init.sh
      - ./matrix-config/start-matrix.sh:/data/start-matrix.sh
      - matrix-data:/data/media
    depends_on:
      config-renderer:
        condition: service_healthy
      postgres:
        condition: service_healthy
      matrix-auth-service:
        condition: service_started
    env_file:
      - .env
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8448/_matrix/client/versions"]
      interval: 10s
      timeout: 5s
      retries: 5
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        # Install envsubst and jq if not already available
        apt-get update && apt-get install -y gettext-base jq curl python3
        chmod +x /data/start-matrix.sh
        chmod +x /data/init.sh
        /data/start-matrix.sh &
        sleep 15 && /data/init.sh &
        wait
    networks:
      - api-network

  matrix-web:
    image: nginx:alpine
    container_name: openmeet_matrix_web
    ports:
      - "80:80"
    volumes:
      - ./matrix-config/.well-known:/usr/share/nginx/html/.well-known
      - ./matrix-config/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - matrix
    networks:
      - api-network

  # NestJS API with hot reload
  api:
    image: node:24-alpine
    user: "${UID:-1000}:${GID:-1000}"
    container_name: openmeet_api
    hostname: api
    working_dir: /app
    command: sh -c "npm install && npm run start:dev:nodemon"
    ports:
      - ${APP_PORT}:${APP_PORT}
    volumes:
      - .:/app
    environment:
      - NODE_ENV=development
      - TZ=UTC
      # Enable polling for file watching in Docker
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=1000
      # Override localhost hosts for container networking
      - DATABASE_HOST=postgres
      - ELASTICACHE_HOST=redis
      - MAIL_HOST=maildev
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://tracing:4318
    env_file:
      - .env
    networks:
      - api-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:${APP_PORT}/health/liveness || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  tracing:
    image: jaegertracing/jaeger:latest
    ports:
      - 6831:6831/udp
      - 6832:6832/udp
      - 5778:5778
      - 16686:16686
      - 4317:4317
      - 4318:4318
      - 14250:14250
      - 14268:14268
      - 14269:14269
      - 9411:9411
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - api-network

  # RabbitMQ for Bluesky event ingestion pipeline
  rabbitmq:
    image: rabbitmq:4.2-management-alpine
    container_name: openmeet_rabbitmq
    ports:
      - "5672:5672"    # AMQP
      - "25672:15672"  # Management UI (using 25672 to avoid Windows Hyper-V port reservation)
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - api-network

  # Bluesky Firehose Consumer - connects to Bluesky and publishes to RabbitMQ
  bsky-firehose-consumer:
    image: node:24-alpine
    user: "${UID:-1000}:${GID:-1000}"
    container_name: bsky-firehose-consumer
    working_dir: /app
    command: sh -c "npm install && npm run start:dev"
    ports:
      - "3001:3001"
    volumes:
      - ../bsky-firehose-consumer:/app
    environment:
      - NODE_ENV=development
      - PORT=3001
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
      - RABBITMQ_EXCHANGE=community.lexicon.calendar
      - RABBITMQ_QUEUE_NAME=community.lexicon.calendar.queue
      - BSKY_FIREHOSE_URL=wss://jetstream2.us-east.bsky.network/subscribe
      - BSKY_COLLECTIONS=community.lexicon.calendar.event,community.lexicon.calendar.rsvp
      - ENABLE_TRACING=true
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://tracing:4318
      - OTEL_SERVICE_NAME=bsky-firehose-consumer
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - api-network
    restart: unless-stopped

  # Bluesky Event Processor - consumes from RabbitMQ and calls OpenMeet API
  # Optional: requires bsky-firehose-consumer sibling repo
  # Required env vars in .env:
  #   BSKY_API_KEY - service API key for OpenMeet API auth
  #   BSKY_TENANT_ID - tenant ID (e.g., lsdfaopkljdfs for local dev)
  bsky-event-processor:
    image: node:24-alpine
    user: "${UID:-1000}:${GID:-1000}"
    container_name: bsky-event-processor
    working_dir: /app
    command: sh -c "npm install && npm run start:dev"
    ports:
      - "3002:3002"
    volumes:
      - ../bsky-event-processor:/app
    environment:
      - NODE_ENV=development
      - PORT=3002
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672
      - RABBITMQ_EXCHANGE=community.lexicon.calendar
      - RABBITMQ_QUEUE_NAME=community.lexicon.calendar.queue
      - API_URL=http://api:${APP_PORT}
      - API_KEY=${BSKY_API_KEY}
      - API_TENANT_ID=${BSKY_TENANT_ID}
      - ENABLE_TRACING=true
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://tracing:4318
      - OTEL_SERVICE_NAME=bsky-event-processor
    env_file:
      - .env
    depends_on:
      rabbitmq:
        condition: service_healthy
      api:
        condition: service_healthy
    networks:
      - api-network
    restart: unless-stopped

  # =============================================================================
  # PDS Services (--profile pds)
  # Isolated PDS + PLC for local ATProto testing - DIDs stay local, not on public plc.directory
  # =============================================================================

  # Isolated PLC directory - stores DIDs locally instead of public plc.directory
  plc:
    profiles: ["pds"]
    image: itaru2622/bluesky-did-method-plc:latest
    container_name: openmeet_plc
    restart: unless-stopped
    ports:
      - "2582:2582"
    environment:
      PORT: 2582
      DEBUG_MODE: "1"
      LOG_ENABLED: "true"
      LOG_LEVEL: "debug"
      LOG_DESTINATION: "1"
      NODE_ENV: development
      ENABLE_MIGRATIONS: "true"
      DATABASE_URL: postgres://${DATABASE_USERNAME}:${DATABASE_PASSWORD}@postgres:5432/plc
      DB_CREDS_JSON: '{"username":"${DATABASE_USERNAME}","password":"${DATABASE_PASSWORD}","host":"postgres","port":"5432","database":"plc"}'
      DB_MIGRATE_CREDS_JSON: '{"username":"${DATABASE_USERNAME}","password":"${DATABASE_PASSWORD}","host":"postgres","port":"5432","database":"plc"}'
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:2582/_health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - api-network

  # PDS (Personal Data Server) pointing to isolated PLC
  pds:
    profiles: ["pds"]
    image: ghcr.io/bluesky-social/pds:0.4
    container_name: openmeet_pds
    restart: unless-stopped
    ports:
      - "3101:3000"
    environment:
      PDS_HOSTNAME: pds.test
      PDS_PORT: 3000
      PDS_DATA_DIRECTORY: /pds
      PDS_BLOBSTORE_DISK_LOCATION: /pds/blocks
      PDS_DID_PLC_URL: http://plc:2582
      PDS_SERVICE_HANDLE_DOMAINS: .pds.test
      PDS_JWT_SECRET: local-dev-jwt-secret-not-for-production
      PDS_ADMIN_PASSWORD: local-dev-admin-password
      PDS_PLC_ROTATION_KEY_K256_PRIVATE_KEY_HEX: "0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef"
      PDS_EMAIL_SMTP_URL: smtp://maildev:1025
      PDS_EMAIL_FROM_ADDRESS: noreply@pds.test
      PDS_DEV_MODE: "true"
      PDS_INVITE_REQUIRED: "true"
      LOG_ENABLED: "true"
    volumes:
      - pds-data:/pds
    depends_on:
      plc:
        condition: service_healthy
      maildev:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/xrpc/_health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - api-network

volumes:
  dbdata:
  matrix-data:
  matrix-configs:
  mas-data:
    driver: local
  pds-data:

networks:
  api-network:
    name: api-network  # Explicit name to avoid project prefix
    driver: bridge