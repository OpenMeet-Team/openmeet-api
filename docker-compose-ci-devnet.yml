# ATProto devnet overlay for CI
#
# Bridges atproto-devnet services (PDS, PLC) into the CI docker environment,
# reusing CI's postgres and maildev. Suppresses Jetstream/TAP/init since
# they aren't needed for e2e tests.
#
# Usage (in GitHub Actions):
#   docker compose \
#     -f docker-compose.relational.ci.yaml \
#     -f ../atproto-devnet/docker-compose.yml \
#     -f docker-compose-ci-devnet.yml \
#     --env-file env-example-relational-ci \
#     -p ci-relational up --build --exit-code-from api

services:
  # ── Connect devnet PLC to CI's postgres ──────────────────────────
  plc:
    environment:
      DEVNET_DB_HOST: postgres
      DEVNET_DB_USER: ${DATABASE_USERNAME}
      DEVNET_DB_PASSWORD: ${DATABASE_PASSWORD}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - default

  # ── Connect devnet PDS to CI's maildev + CI-specific config ──────
  pds:
    environment:
      PDS_HOSTNAME: pds.test
      PDS_ADMIN_PASSWORD: ci-pds-admin-password
      PDS_JWT_SECRET: ci-pds-jwt-secret-not-for-production
      PDS_EMAIL_SMTP_URL: smtp://maildev:1025
      PDS_EMAIL_FROM_ADDRESS: noreply@test.invalid
      PDS_SERVICE_HANDLE_DOMAINS: .pds.test
      PDS_DEV_MODE: "true"
    depends_on:
      maildev:
        condition: service_started
    networks:
      - default

  # ── Suppress services not needed for CI e2e tests ────────────────
  jetstream:
    profiles: [devnet-full]
  tap:
    profiles: [devnet-full]
  init:
    profiles: [devnet-full]
